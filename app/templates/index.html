{% extends "base.html" %}

{% block page_title %}Home{% endblock %}

{% block content %}

<!-- TODO: Move this live region to a better location. -->
<div role="status" aria-live="polite">
    <!-- add content to hear it spoken -->
</div>

<h1 id="posts-table-label">Job Posts</h1>
{% if not jobs %}
<div class="border border-black border-2 rounded-2 container-md p-5">
    <p>No jobs here yet. Go to settings to set up options and run a search manually.</p>
</div>

{% else %}
<div class="table-container border border-black border-2 rounded-2 vh-75 container-md p-0">
    <!-- <div class="empty-state">
        <p>No job posts here yet. Click the button to run a search manually.</p>
    </div> -->
    {% include 'posts_table.html' %}
</div>

<br />
<!-- Table Settings -->
<h2>Table Settings</h2>
{% include 'posts_table_settings.html' %}
<br />
<h2>Filters</h2>
{% include 'data_filters.html' %}
<br />

{% endif %}

{% endblock %}
{% block scripts %}
{{ super() }}

<script>

    const filterOptions = {{ filters.settings | tojson }}

    function getFilterSettings(inputId, selectedOption) {
        console.log('selected option: ', selectedOption)
        const filterNum = inputId.split('_')[1]
        //console.log('all_filters: ', all_filters)
        const filter = filterOptions[selectedOption]
        //console.log('selected_filter: ', filter)

        function getOptionsText(valuesLabelsList) {
            let options = ''
            valuesLabelsList.forEach((valueLabel, i) => {
                selected = ''
                if (i === 0) { selected = 'selected ' }
                options += `<option ${selected}value="${valueLabel[0]}">${valueLabel[1]}</option>`
            })
            return options
        }

        function getInputText(type, value = '') {
            return (`<input type="${type}" class="form-control" id="filter-value_text_1" name="value" value="${value}" aria-label="Value" />`)
        }

        const filterRow = document.getElementById('filter-row_' + filterNum)

        // Operator options
        const operatorOptions = getOptionsText(filter['op_list'])
        const operatorSelect = filterRow.querySelector('.filter-operator .form-select')
        operatorSelect.innerHTML = operatorOptions
        operatorSelect.classList.remove('d-none')

        // Field Values

        // Set display:none for all '.filter-value' elements within filterRow
        const valueDiv = filterRow.querySelector('div.filter-value')

        //for (let i = 0; i < valueDivs.length; i++) {
        //    if (!valueDivs[i].classList.contains('d-none')) {
        //        valueDivs[i].classList.add('d-none')
        //    }
        //}

        // Get element matching filter's input type
        //const valueDiv = filterRow.querySelector(`.filter-value.filter-${filter['input_type']}`)

        // Make modifications to value element
        if (filter['input_type'] === 'multi-select') {

            const valueOptions = getOptionsText(filter.values)
            const valueSelectText = `<select class="form-select" id="filter-value_multi-select_${filterNum}" name="value" aria-label="Value">${valueOptions}</select>`
            valueDiv.innerHTML = valueSelectText

            //const valueSelect = valueDiv.querySelector('.form-select')
            //const valueOptions = getOptionsText(filter.values)
            //valueSelect.innerHTML = valueOptions
        }
        else {
            //const valueInputEl = valueDiv.querySelector('.form-control')
            let value = ''
            if (filter.values) {
                value = filter.values
                //valueInputEl.setAttribute('value', filter.values)
            }
            valueText = getInputText('text', value)
            valueDiv.innerHTML = valueText
        }

        // Un-hide element
        valueDiv.classList.remove('d-none')



        // // ...Or, could get filter option data by fetch, and get the entire option list, or entire div maybe...
        // element = getElementById('...') //...

        // let data = new FormData()
        // data.append('name', options_value)
        // {# url = {{ url_for('filter_options') | tojson }} #}

        // getHtml(url, selected_option).then(text => element.innerHTML = text)
    }


    // TODO: Use fetch pattern to create a new filter input row when click an "Add filter" button

    function addFilterRow(el_id) {
        const filterData = document.getElementById('filterData').getAttribute('value')
        console.log(filterData)

        const groupNum = inputId.split('_g')[1]

    }


    //{# const filterData = {{ filters.current | tojson }} #}

    //console.log(document.getElementById('filterData').getAttribute('value'))

    function getHtml(url, data) {

        request = {
            "method": "POST",
            "body": data,
        }

        return fetch(room_url, request)
            .then(response => response.text)
        // .then(text => element.innerHTML = text)
    }



    // example LIVE REGION script -- for alert/status messages to be read by Voice Readers 
    // var todoName = document.querySelector('[type="text"]').value;
    // const formBtn = document.querySelector(".settings-btn");

    function announceSave() {
        // const testButton = document.querySelector("#test-button");
        // testButton.text = ''

        const liveRegion = document.querySelector('[role="status"]');
        liveRegion.textContent = `Settings were saved.`;
        setTimeout(() => { liveRegion.textContent = '' }, 5000)
    }

    // formBtn.addEventListener("click", announceSave());

</script>
{% endblock %}