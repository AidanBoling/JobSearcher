{% extends "base.html" %}
{% from 'general_components.html' import iconBtnContent %}

{% block page_title %}View Job Posts{% endblock %}

{% block content %}

{# TODO: Add ability to change sort-by field(s) #}

<!-- Later TODO: Move this live region to a better location. -->
<div role="status" aria-live="polite">
    <!-- add content to hear it spoken -->
</div>

<h1 id="posts-table-label" class="pt-2">Job Posts</h1>

<div class="dataview-frame shadow">
    <div class="d-flex mb-2 flex-row justify-content-between view-border" id="data-view-controls">

        <div class="d-flex flex-row">
            <label class="me-2 align-self-center fs-5" id="views-label">View </label>
            <div class="dropdown" id="saved-views-dropdown" data-inclusive-menu aria-labelledby="views-label">
                <button
                    class="dropdown-toggle btn btn-outline-light btn-light-soft rounded-1 d-flex flex-row align-items-center"
                    data-inclusive-menu-opens="views-menu">
                    <span class="justify-self-center">{{ views.current.name|capitalize }}</span>
                </button>
                <div id="views-menu" class="list-group shadow">
                    {% for view in views.names %}
                    <button class="list-group-item list-group-item-action"
                        {% if view == views.current.name %}aria-checked="true"
                        {% endif %}>{{ view|capitalize }}</button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="btn-group" role="group" aria-label="View Settings">
            <button class="btn btn-outline-light btn-light-soft btn-icon" type="button" data-bs-toggle="modal"
                data-bs-target="#settingsModal-filters">
                {{ iconBtnContent('bi bi-funnel', 'Filters', icon_style='font-size: 1.2rem;') }}
            </button>
            <div class="vr"></div>
            <button class="btn btn-outline-light btn-light-soft btn-icon" type="button" data-bs-toggle="modal"
                data-bs-target="#settingsModal-layoutSettings">
                {{ iconBtnContent('bi bi-gear', 'Settings', icon_style='font-size: 1.2rem;') }}
            </button>
        </div>

    </div>

    <div id="dataview-main">
        {% include 'dataview.html' %}
    </div>

    <div class="d-flex">
        <span class="align-self-end" aria-live=”polite” role=”region”> {{ jobs|length }} Jobs</span>
    </div>
</div>


{% endblock %}


{% block scripts %}
{{ super() }}

{% include 'data_filters_js.html' %}

<script>

    // VIEW NAVIGATION

    const get_view_url = {{ url_for('change_view') | tojson }}
    const views = {{ views | tojson }}

    // Menu button instantiation
    const viewsButton = document.querySelector('[data-inclusive-menu-opens="views-menu"]')
    const viewsMenuButton = new MenuButton(viewsButton, { checkable: 'one' })

    const changeViewForm = document.getElementById('change-view-form')
    const dataviewSection = document.querySelector('#dataview-main')

    const dataviewTable = document.querySelector('#dataview-table')
    const dataviewList = document.querySelector('#dataview-list')

    // Listen to choose event
    viewsMenuButton.on('choose', function (choice) {
        const viewSelected = choice.innerText.trim()
        viewsButton.innerText = viewSelected

        // TODO: Deal with when current view is deleted
        // TODO: Handle when view is not found on backend
        //      (i.e. need to figure how to update history, etc. Maybe throw error from backend?)

        function updateView(viewName) {
            const view = viewName.toLowerCase();

            if (!views.names.includes(view)) {
                console.log('Selected view name not found.');
                return;
            }

            let data = new FormData()
            data.append("view", view)
            request = {
                'method': 'POST',
                'body': data,
            }

            fetch(get_view_url, request)
                .then(response => {
                    return response.text();
                })
                .then(html => {
                    updateHistory(html, view);
                    return dataviewSection.innerHTML = html
                })
        }

        function updateHistory(data, view) {
            console.log('Updating history...')
            const pathname = view
            //history.replaceState()
            history.pushState(data, "", pathname);
        }

        updateView(viewSelected)
        console.log('You chose "' + choice.innerText + '"')
    })

    // Handle forward/back buttons
    window.addEventListener("popstate", (event) => {
        if (event.state) {
            // Simulate the loading of the previous page
            dataviewSection.innerHTML = event.state
        }
    });

    // Set initial state on browser page load
    const initialState = dataviewSection.innerHTML
    history.replaceState(initialState, "", document.location.href);



    // OTHER

    // Put focus on first input of edit modal
    const editModals = document.querySelectorAll('.edit-modal')

    editModals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', (e) => {
            const myInput = e.target.querySelector('.edit-modal input')
            myInput.focus()
        })
    }
    )


    // example LIVE REGION script -- for alert/status messages to be read by Voice Readers 
    // var todoName = document.querySelector('[type="text"]').value;

    function sendToLiveRegion(message) {
        const liveRegion = document.querySelector('[role="status"]');
        liveRegion.textContent = message;
        setTimeout(() => { liveRegion.textContent = '' }, 5000)
    }

    function announceSave() {
        const liveRegion = document.querySelector('[role="status"]');
        liveRegion.textContent = `Settings were saved.`;
        setTimeout(() => { liveRegion.textContent = '' }, 5000)
    }

    // formBtn.addEventListener("click", announceSave());

</script>

{% endblock %}


{# ----- Trash (TEMP) ---- #}


{# View format: [Table, List] #}

{# <div class="dropdown">
        <button type="button" class="btn btn-outline-light btn-lg dropdown-toggle" data-bs-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false" data-bs-auto-close="outside">
            Change view
        </button>

        <div class="dropdown-menu">
            <form id="change-view-form" class="container">
                <div class="row justify-content-between">
                    <div class="col-4 p-0">
                        <fieldset class="px-5 mt-1">
                            <legend class="visually-hidden">Select a saved view</legend> #}
{# {% for view in views.names %} #}
{# <div class="form-check p-2">
                                <input class="form-check-input me-1" type="radio" value="{{ view }}"
                                    id="view-option-{{ view }}" name="view"
                                    {% if view == views.current.name %}checked{% endif %}>
                                <label class="form-check-label"
                                    for="view-option-{{ view }}">{{ view|capitalize }}</label>
                            </div> #}
{# {% endfor %} #}
{# </fieldset>
                    </div>
                </div>
                <button class="settings-btn btn btn-primary px-4" type="submit">Go to View</button>
            </form>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Create New View</a>
        </div>
    </div> #}

{# <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Current view: {{ views.current.name|capitalize }}
        </button>
        <ul class="dropdown-menu"> #}
{# {% for view in views.names %}
            <li><a href="{{ url_for('get_view', view=view) }}"
                    class="dropdown-item {% if view == views.current.name %}active{% endif %}"
                    {% if view == views.current.name %}aria-current="true" {% endif %}>{{ view|capitalize }}</a></li>
            {% endfor %} #}
{# </ul>
    </div> #}