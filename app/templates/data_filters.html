{% from 'general_components.html' import iconBtnContentSvg %}

{# Filter Groups, Rows #}

{% macro filter_group(filter_options, job_fields, number=1, prev_group_number=0, prev_group_id_post='', outer_group_op_el='', name_prefix='group', filters_current={'group_op': 'AND', 'filters': []}, class_row='') %}
<div
    class="{% if prev_group_number > 0 %}group-inner outer-row {% endif %}row {{ class_row }} in-group-{{ prev_group_number }}">

    {% if prev_group_number > 0 %}
    {{ group_outer_column_wrapper(inner_content=outer_group_op_el, class_div_cols='row-start') }}
    {% endif %}

    <!--<fieldset>
            <legend>Filter Group</legend> -->
    {% set ns = namespace() %}
    {% set ns.group_id_post = '{}-{}'.format(prev_group_id_post, number) %}

    {% if prev_group_number == 0 %}
    {% set ns.group_id_post = number %}
    {% endif %}

    <div class="filter-group in-group-{{ prev_group_number }} col g-col-outer" id="filter-group_{{ ns.group_id_post }}">
        <div class="row">
            {% set group_op_id_post = 'g{}'.format(ns.group_id_post) %}

            {% if filters_current['filters']|length < 2 %}
            {{group_op_element(div_class_inner='col-auto d-inline d-none {}'.format(class_col_inner), current_group_op=filters_current['group_op'], name_prefix=name_prefix, id_post=group_op_id_post, selected='AND') }}
            {% endif %}

            <div class="col g-col-inner">
                {% set ns.group_num = 0 %}
                {% set ns.filter_row_num = 0 %}

                {# Loop through each filter #}
                {% for f in filters_current['filters'] %}

                {# Only show form select input for operator on 2nd filter item of a group. 
                For all filter items > 2, show "echo" -- just the operator value text . #}

                {% set ns.group_op_is_empty = false %}
                {% set ns.group_op_is_echo = false %}
                {% if loop.index < 2 %}
                {% set ns.group_op_is_empty = true %}
                {% elif loop.index > 2 %}
                {% set ns.group_op_is_echo = true %}
                {% endif %}

                {% set group_op_el = group_op_element(current_group_op=filters_current['group_op'], name_prefix=name_prefix, id_post=group_op_id_post, is_empty=ns.group_op_is_empty, is_echo=ns.group_op_is_echo, div_style='width: 80px;') %}

                {% set keys = f.keys()|list %}
                {% if 'group_op' in keys %}
                {# If is group #}
                {% set ns.group_num = ns.group_num + 1 %}
                {{ filter_group(filter_options=filter_options, job_fields=job_fields, number=ns.group_num, prev_group_number=number, prev_group_id_post=ns.group_id_post, outer_group_op_el=group_op_el, name_prefix='{}.{}.group'.format(name_prefix, loop.index0), filters_current=f) }}

                {% else %}
                {# If is row #}
                {% set ns.filter_row_num = ns.filter_row_num + 1 %}
                {{ filter_row(group_id_post=ns.group_id_post, number=ns.filter_row_num, f_options=filter_options, job_fields=job_fields, group_op_element=group_op_el, name_prefix='{}.{}.filter'.format(name_prefix, loop.index0), filter_current=f, class_row='')
                }}
                {% endif %}

                {% endfor %}

                <div class="filter-btn row">
                    <div class="{% if prev_group_number > 0 %}col{% else %}col-8{% endif %} btn-group filter-btn-group"
                        role="group" aria-label="Add Filters">
                        <button type="button" class="filter-btn btn ab-btn-dark-color with-hover-border"
                            id='add-filter_g{{ ns.group_id_post }}' onclick="addFilter('row', this, this.id)">
                            {{ iconBtnContentSvg('#svg-bi-plus-lg', 'Add Filter') }}
                        </button>
                        <div class="vr"></div>
                        <button type="button" class="filter-btn btn ab-btn-dark-color with-hover-border"
                            id='add-filter-group_g{{ ns.group_id_post }}' onclick="addFilter('group', this, this.id)">
                            {{ iconBtnContentSvg('#svg-bi-subtract', 'Add Group') }}
                        </button>
                    </div>

                    {% if prev_group_number == 0 %}
                    <div class="col d-flex justify-content-end">
                        <button class="remove-all-btn btn ab-btn-danger with-hover-border w-150 align-self-end"
                            type="button" onclick="removeAllFilters(this)"
                            {% if not filters_current.filters %}disabled{% endif %}>
                            {{ iconBtnContentSvg('#svg-bi-trash3', text='Clear All') }}
                        </button>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
    <!-- </fieldset> -->
    {% if prev_group_number > 0 %}
    {{ group_outer_column_wrapper(inner_content=deleteFilterBtn('group'), class_div_cols='row-end') }}
    {% endif %}
</div>
{% endmacro %}


{% macro filter_row(group_id_post, number, f_options, job_fields, group_op_element, name_prefix, filter_current={}, class_row='gx-2 py-2') %}
{% set id_post = 'g{}-{}'.format(group_id_post, number) %}

<div class="filter-row row outer-row in-group-{{ group_id_post }} {{ class_row }}" id="filter-row_{{ id_post }}">
    {{ group_op_element }}

    {# Field #}
    <div class="col-4 filter-field">
        <select name="{{ name_prefix }}.field" id="field-name_{{ id_post }}" class="form-select" aria-label="Field Name"
            onchange="getFilterOptions(this.id, this.name, this.options[this.selectedIndex].value)">

            {% if not filter_current %}
            <option value="" selected>Select field</option>
            {% endif %}

            {% set keys = f_options.keys()|list %}
            {% for field in job_fields if field.name in keys %}

            {% if filter_current and field.name == filter_current['field'] %}
            <option value="{{ field.name }}" selected>{{ field.label }}</option>

            {% else %}
            <option value="{{ field.name }}">{{ field.label }}</option>
            {% endif %}

            {% endfor %}
        </select>
    </div>

    {# Operator and Value #}
    {% if filter_current %}
    {# -- Operator #}
    {{ filter_select(item='filter-operator', name='{}.operator'.format(name_prefix), id_post=id_post,
    aria_label='Operator', div_class='col-2', options=f_options[filter_current['field']]['op_list'],
    selected_option=filter_current['operator']) }}

    {# -- Value #}
    {% if f_options[filter_current['field']]['input_type'] == 'multi-select' %}

    {{ filter_select_multi(item='filter-value', name='{}.values'.format(name_prefix), id_post=id_post,
    aria_label='Values', div_class='col', options=f_options[filter_current['field']]['values'],
    selected_options=filter_current['values']) }}

    {% else %}
    {{ filter_input(item='filter-value', type='text', name='{}.values'.format(name_prefix), id_post=id_post,
    aria_label='Value', div_class='col', value=filter_current['values']) }}

    {% endif %}

    {% else %}

    {# -- Operator #}
    {{ filter_select(item='filter-operator', name='{}.operator'.format(name_prefix), id_post=id_post,
    aria_label='Operator', div_class='col-2', class='d-none') }}

    {# -- Value #}
    {{ filter_select(item='filter-value', name='{}.values'.format(name_prefix), id_post=id_post,
    aria_label='Value', div_class='col', class='d-none') }}

    {% endif %}

    <div class="col-auto d-inline">
        {{ deleteFilterBtn(filter_type='row') }}
    </div>
</div>
{% endmacro %}


{# Components and Wrappers #}

{% macro group_outer_column_wrapper(inner_content, class_div_cols, class_div_inner='row outer-row') %}
<div class="col g-col-outer row-cap {{ class_div_cols }}">
    <div class="row">
        <div class="col g-col-inner row-cap {{ class_div_cols }}">
            <div class="{{ class_div_inner }}">
                {{ inner_content|safe }}
            </div>
        </div>
    </div>
</div>
{% endmacro %}


{% macro group_op_element(current_group_op, name_prefix, id_post, selected='', div_class_inner='col-auto d-inline', is_empty=false, is_echo=false, div_style='width: 80px;') %}

{% set options = [('AND', 'And'), ('OR', 'Or')] %}
{% set onchange = 'updateOpEchos(this, this.options[this.selectedIndex].value)' %}
{% set ns = namespace(selected = selected) %}
{% if not ns.selected %}
{% set ns.selected = current_group_op %}
{% endif %}

{% if is_empty %}
<div class="{{ div_class_inner }} group-op-first">
    <div class="op-text" style="{{ div_style }}">Where</div>
</div>
{% elif is_echo %}
<div class="{{ div_class_inner }} group-op-echo">
    <div class="op-text" style="{{ div_style }}">{{ current_group_op|title }}</div>
</div>
{% else %}

{{ filter_select(item='group-operator', name='{}.group_op'.format(name_prefix), id_post=id_post,
                aria_label='Filter Group Operator', div_class=div_class_inner, options=options, selected_option=ns.selected, class='', style=div_style, onchange=onchange) }}
{% endif %}

{% endmacro %}


{% macro deleteFilterBtn(filter_type) %}
<div class="remove-button">
    <button class="btn ab-btn-light start-grey" type="button" onclick="deleteFilter(this, '{{ filter_type }}')"><i
            class="bi bi-trash3" aria-hidden="true"></i>
        <span class="visually-hidden">Remove</span></button>
</div>
{% endmacro %}


{# -- Components: Form Fields #}

{% macro filter_select(item, name, id_post, aria_label, div_class='col-4', class='', options=[], selected_option='', style='', onchange='') %}
<div class="{{ div_class }} {{ item }}">
    <select class="form-select {{ class }}" name="{{ name }}" id="{{ item }}_{{ id_post }}"
        aria-label="{{ aria_label }}" style="{{ style }}" {% if onchange %}onchange="{{onchange}}" {% endif %}>
        {% if options %}

        {% for option in options %}
        {% if option[0] == selected_option %}
        <option value="{{ option[0] }}" selected>{{ option[1] }}</option>
        {% else %}
        <option value="{{ option[0] }}">{{ option[1] }}</option>
        {% endif %}
        {% endfor %}

        {% endif %}
    </select>
</div>
{% endmacro %}


{# TODO: Fix multi-select to actually be multi-select --> checkboxes #}
{% macro filter_select_multi(item, name, id_post, aria_label, div_class='col-4', class='', options=[], selected_options=[]) %}
<div class="{{ div_class }} {{ item }}">
    <select class="form-select {{ class }}" name="{{ name }}" id="{{ item }}_{{ id_post }}"
        aria-label="{{ aria_label }}">
        {% if options %}

        {% for option in options %}
        {% if option[0] in selected_options %}
        <option value="{{ option[0] }}" selected>{{ option[1] }}</option>
        {% else %}
        <option value="{{ option[0] }}">{{ option[1] }}</option>
        {% endif %}
        {% endfor %}

        {% endif %}
    </select>
</div>
{% endmacro %}


{% macro filter_input(item, type, name, id_post, aria_label, div_class='col-4', class='', value='') %}
<div class="{{ div_class }} {{ item }}">
    <input type="{{ type }}" id="{{ item }}_{{ type }}_{{ id_post }}" aria-label="{{ aria_label }}"
        class="form-control {{ class }}" name="{{ name }}" {% if value %}value="{{ value }}" {% endif %} />
</div>
{% endmacro %}



<!-- <div class="col-4 filter-value filter-text d-none">
    <label for="filter-value_text_1" class="form-label"></label> 
    <input type="text" class="form-control" id="filter-value_text_1" name="value" value=""
        aria-label="Value" />
</div>-->

<!--<div class="col-4 filter-value filter-date d-none">
    <label for="filter-value_date_1" class="form-label"></label>
    <input type="date" class="form-control" id="filter-value_date_1" name="value" value=""
        aria-label="Value" />
</div>-->


{# outer = 'col-auto {{div_outer}}'
inner = 'col-auto d-inline {{div_outer}}' #}